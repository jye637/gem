<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蔡文國小20251226Gem增能研習</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Fredoka+One&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; scroll-behavior: smooth; }
        .vibrant-bg { background: linear-gradient(120deg, #fdfbfb 0%, #ebf8ff 100%); }
        .card-pop { 
            background: white;
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.08);
            transition: all 0.3s ease;
        }
        .card-pop:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(59, 130, 246, 0.12); }
        .nav-button {
            padding: 8px 16px;
            border-radius: 12px;
            transition: all 0.2s;
            color: #4b5563;
        }
        .nav-button:hover { background: #eff6ff; color: #2563eb; }
        .nav-button.active { background: #2563eb; color: white; }
        .animate-fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .content-wrap { white-space: pre-wrap; word-break: break-all; }
        
        /* 加載動畫 */
        .spinner {
            animation: rotate 2s linear infinite;
            width: 24px;
            height: 24px;
            border: 3px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
        }
        @keyframes rotate { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="vibrant-bg min-h-screen text-gray-800">

    <div id="app" class="max-w-6xl mx-auto px-4 py-8">
        <!-- 導覽列 -->
        <nav class="flex flex-col lg:flex-row justify-between items-center mb-8 gap-6 bg-white/80 backdrop-blur-md p-4 rounded-3xl shadow-sm sticky top-4 z-40 border border-blue-50">
            <h1 onclick="showSection('home')" class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-cyan-500 flex items-center gap-2 cursor-pointer">
                <i data-lucide="sparkles" class="text-yellow-400 fill-yellow-400"></i> 20251226蔡文國小Gem增能研習
            </h1>
            <div id="nav-links" class="flex flex-wrap justify-center gap-2 text-sm font-bold">
                <button onclick="showSection('home')" class="nav-button">首頁</button>
                <button onclick="goToUnit(0)" class="nav-button">1.班級經營</button>
                <button onclick="goToUnit(1)" class="nav-button">2.學科教學</button>
                <button onclick="goToUnit(2)" class="nav-button">3.親師溝通</button>
                <button onclick="goToUnit(3)" class="nav-button">4.班級活動</button>
                <button id="nav-results-btn" onclick="showResults()" class="px-5 py-2 bg-gradient-to-r from-orange-400 to-pink-500 text-white rounded-full hover:scale-105 transition flex items-center gap-2 shadow-md">
                    <i data-lucide="award" class="w-4 h-4"></i> 查看研習成果牆
                </button>
            </div>
        </nav>

        <!-- 首頁 -->
        <section id="home-section" class="section-block space-y-8 animate-fade-in">
            <div class="card-pop p-8 md:p-12 border-t-8 border-blue-500">
                <div class="max-w-3xl mx-auto text-center mb-12">
                    <h2 class="text-4xl font-black mb-4 text-gray-900 leading-tight">讓 AI 成為您的超強教練！✨</h2>
                    <p class="text-xl text-gray-500">歡迎蔡文國小的夥伴，體驗 AI 自動即時評鑑功能。</p>
                </div>
                
                <div class="bg-gray-50 rounded-3xl p-8 border border-dashed border-gray-300">
                    <h3 class="text-2xl font-bold mb-6 text-center">開始之前，先許個願吧！</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">我是...</label>
                                <input type="text" id="user-name" class="w-full p-4 rounded-2xl border-2 border-white bg-white shadow-sm focus:border-blue-400 outline-none transition" placeholder="您的姓名">
                            </div>
                            <button onclick="submitWish()" id="btn-submit-wish" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl hover:bg-blue-700 transition-all hover:shadow-xl hover:scale-[1.02] active:scale-95 shadow-lg shadow-blue-200 text-lg">
                                開啟 Gem 研習單元
                            </button>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">您的 AI 願望是？</label>
                            <textarea id="ai-wish" rows="4" class="w-full p-4 rounded-2xl border-2 border-white bg-white shadow-sm focus:border-blue-400 outline-none transition" placeholder="例如：希望 AI 能幫我批改國語習作的造句..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 學習單元區域 -->
        <section id="units-section" class="section-block hidden space-y-8">
            <div id="unit-content">
                <!-- 動態生成內容 -->
            </div>
        </section>

        <!-- 測驗結果查詢區域 -->
        <section id="results-section" class="section-block hidden space-y-6 animate-fade-in">
            <div class="card-pop p-8 border-t-8 border-orange-400">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-black text-gray-800 flex items-center gap-2">
                            <i data-lucide="layout-list" class="text-orange-500"></i> 蔡文夥伴研習牆
                        </h2>
                        <p class="text-gray-500 mt-1">AI 已自動為老師們的設定進行「角色任務分析」回饋！</p>
                    </div>
                    <div class="flex flex-wrap gap-2 w-full md:w-auto">
                        <button onclick="showResults()" class="p-3 bg-gray-100 rounded-xl hover:bg-gray-200 transition" title="重新整理">
                            <i data-lucide="refresh-cw" class="w-5 h-5 text-gray-600"></i>
                        </button>
                        <div class="relative flex-1 md:w-80">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                            <input type="text" id="search-input" onkeyup="filterResults()" placeholder="搜尋姓名、內容或評語..." class="w-full pl-10 p-3 bg-gray-50 border-2 border-gray-100 rounded-xl text-sm outline-none focus:border-blue-400 transition">
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto rounded-2xl border border-gray-100 min-h-[400px]">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 text-gray-600 text-sm font-black">
                                <th class="py-4 px-6 border-b">老師</th>
                                <th class="py-4 px-6 border-b">學習主題</th>
                                <th class="py-4 px-6 border-b">Gem 設定內容</th>
                                <th class="py-4 px-6 border-b">AI 教練點評</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- 成功提示框 -->
        <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-gray-900/90 backdrop-blur text-white px-8 py-4 rounded-2xl opacity-0 transition-opacity pointer-events-none z-50 shadow-2xl font-bold">
            資料已儲存！
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCxrOlO-PyQZBknKYpC84XYB7wAxBh6tOA",
            authDomain: "myreadingcheckin.firebaseapp.com",
            projectId: "myreadingcheckin",
            storageBucket: "myreadingcheckin.firebasestorage.app",
            messagingSenderId: "476306591390",
            appId: "1:476306591390:web:697f4c3bbf246c4c81358f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = "cai-wen-teacher-ai-coach"; // 建立新的 App ID 以區隔
        const resultsCollectionPath = ['artifacts', appId, 'public', 'data', 'quizResults'];
        const apiKey = ""; // Gemini API Key 會由系統注入

        signInAnonymously(auth);

        const units = [
            { id: 1, title: "班級經營：情緒安撫小助手", desc: "設計專業的心理輔導角色。", gemExample: "你現在是一位溫和的諮商心理老師...", quiz: "如果 AI 是一位資深班導師，它應該具備什麼樣的角色性格與說話語氣？" },
            { id: 2, title: "學科教學：創意教案設計師", desc: "把生澀課程變身冒險遊戲。", gemExample: "你是一位充滿好奇心的冒險家，請設計數學遊戲...", quiz: "如果要讓 AI 設計『國語修辭』教案，您會如何設定它的專家角色背景？" },
            { id: 3, title: "親師溝通：委婉文字翻譯官", desc: "將想說的話，修飾得更有溫度。", gemExample: "你是一位資深親師溝通專家...", quiz: "當孩子發生偏差行為需告知家長，您會要求 AI 以什麼樣的口吻扮演「校園導師」？" },
            { id: 4, title: "班級活動：活動企劃大師", desc: "讓節慶活動不再千篇一律。", gemExample: "你是一位得獎的兒童活動策展人...", quiz: "規劃蔡文國小校慶闖關時，您會希望 AI 扮演什麼樣的角色來提供創意？" }
        ];

        let currentUnitIndex = 0;
        let globalUserName = "";
        let allResults = [];

        const refreshIcons = () => { if (typeof lucide !== 'undefined') lucide.createIcons(); };

        // AI 評分核心邏輯
        async function getAICoachReview(unitTitle, answer) {
            const systemPrompt = `你是一位專業的 Prompt Engineering (提示詞工程) 講師，專門評估國小老師對 Gemini (AI) 的角色設定。
            請根據使用者的回答，檢查是否包含：1.角色設定 (Role) 2.任務目標 (Task) 3.背景細節 (Context)。
            並以 JSON 格式回傳評語。
            JSON 結構為：{"score": 分數1-5, "feedback": "約50字中文建議", "badge": "稱號如: 角色大師/新手教練"}。`;
            
            const userQuery = `學習單元：${unitTitle}\n老師的設定內容：${answer}`;
            
            let retries = 5;
            let delay = 1000;
            
            while (retries > 0) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: userQuery }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });
                    const data = await response.json();
                    return JSON.parse(data.candidates[0].content.parts[0].text);
                } catch (e) {
                    retries--;
                    if (retries === 0) return { score: 3, feedback: "AI 教練目前休息中，您的熱情我們收到了！", badge: "勤奮夥伴" };
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                }
            }
        }

        window.showSection = (id) => {
            const sections = document.querySelectorAll('.section-block');
            sections.forEach(sec => sec.classList.add('hidden'));
            document.getElementById(`${id}-section`).classList.remove('hidden');
            refreshIcons();
        };

        window.goToUnit = (index) => {
            if (!globalUserName) { showToast("請先輸入姓名！"); return; }
            currentUnitIndex = index;
            renderUnit();
            showSection('units');
        };

        window.submitWish = async () => {
            const name = document.getElementById('user-name').value;
            const wish = document.getElementById('ai-wish').value;
            if (!name) { showToast("請輸入姓名！"); return; }
            globalUserName = name;
            await addDoc(collection(db, ...resultsCollectionPath), { 
                unitName: "研習初衷", name, answer: wish || "加油！", timestamp: serverTimestamp(), aiReview: { score: 5, feedback: "非常棒的開始！願望清單已同步到 AI 雲端。", badge: "夢想家" } 
            });
            goToUnit(0);
        };

        window.renderUnit = () => {
            const unit = units[currentUnitIndex];
            document.getElementById('unit-content').innerHTML = `
                <div class="card-pop p-8 md:p-12 border-t-8 border-blue-500 animate-fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-black">${unit.title}</h3>
                        <span class="text-sm font-bold bg-blue-50 text-blue-600 px-4 py-1 rounded-full">UNIT ${unit.id}/4</span>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <p class="text-gray-600 mb-4">${unit.desc}</p>
                            <div class="bg-blue-50 p-6 rounded-2xl mb-6">
                                <h5 class="text-xs font-black text-blue-700 mb-2 uppercase">設定範例</h5>
                                <p class="text-sm italic">「${unit.gemExample}」</p>
                            </div>
                        </div>
                        <div class="bg-yellow-50 p-8 rounded-3xl border-2 border-yellow-200">
                            <h4 class="font-bold mb-3">${unit.quiz}</h4>
                            <textarea id="quiz-answer" rows="5" class="w-full p-4 rounded-2xl mb-4 border-2 border-transparent focus:border-orange-400 outline-none" placeholder="輸入您的設定..."></textarea>
                            <div id="loading-ai" class="hidden items-center gap-3 mb-4 text-blue-600 font-bold">
                                <div class="spinner"></div> AI 教練評鑑中...
                            </div>
                            <button id="submit-btn" onclick="submitQuiz()" class="w-full py-4 bg-gray-900 text-white rounded-2xl font-bold hover:bg-black transition">
                                提交並由 AI 評閱
                            </button>
                        </div>
                    </div>
                </div>
            `;
            refreshIcons();
        };

        window.submitQuiz = async () => {
            const answer = document.getElementById('quiz-answer').value;
            if (!answer) return;
            
            const btn = document.getElementById('submit-btn');
            const loader = document.getElementById('loading-ai');
            btn.disabled = true;
            loader.classList.remove('hidden');

            try {
                const aiReview = await getAICoachReview(units[currentUnitIndex].title, answer);
                await addDoc(collection(db, ...resultsCollectionPath), {
                    unitName: units[currentUnitIndex].title,
                    name: globalUserName,
                    answer,
                    aiReview,
                    timestamp: serverTimestamp()
                });
                showToast("AI 已完成評閱並存檔！");
                if (currentUnitIndex < units.length - 1) { currentUnitIndex++; renderUnit(); }
                else { showFinalSuccess(); }
            } catch (e) { showToast("提交發生錯誤"); }
        };

        window.showResults = async () => {
            showSection('results');
            const tbody = document.getElementById('results-table-body');
            tbody.innerHTML = '<tr><td colspan="4" class="py-20 text-center text-gray-400"><div class="spinner mx-auto mb-2"></div>載入夥伴創意與 AI 回饋中...</td></tr>';
            
            try {
                const snap = await getDocs(collection(db, ...resultsCollectionPath));
                allResults = snap.docs.map(d => d.data()).sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                renderTable(allResults);
            } catch (e) { tbody.innerHTML = '<tr><td colspan="4" class="py-20 text-center">目前尚無資料</td></tr>'; }
        };

        window.filterResults = () => {
            const kw = document.getElementById('search-input').value.toLowerCase();
            const filtered = allResults.filter(r => 
                r.name.toLowerCase().includes(kw) || r.answer.toLowerCase().includes(kw) || (r.aiReview?.feedback || "").toLowerCase().includes(kw)
            );
            renderTable(filtered);
        };

        function renderTable(data) {
            document.getElementById('results-table-body').innerHTML = data.map(r => `
                <tr class="border-b hover:bg-white transition group">
                    <td class="py-6 px-6 align-top">
                        <div class="font-bold text-gray-800">${r.name}</div>
                        <div class="text-[10px] text-gray-400 uppercase tracking-tighter">${r.aiReview?.badge || '研習生'}</div>
                    </td>
                    <td class="py-6 px-6 align-top">
                        <span class="text-xs font-bold text-blue-500">${r.unitName}</span>
                    </td>
                    <td class="py-6 px-6 align-top max-w-md">
                        <div class="content-wrap text-sm text-gray-600 bg-gray-50 p-4 rounded-xl select-all">${r.answer}</div>
                    </td>
                    <td class="py-6 px-6 align-top">
                        <div class="bg-white border border-orange-100 p-4 rounded-xl shadow-sm">
                            <div class="flex gap-1 mb-2">
                                ${Array(5).fill(0).map((_, i) => `<i data-lucide="star" class="w-3 h-3 ${i < (r.aiReview?.score || 0) ? 'fill-orange-400 text-orange-400' : 'text-gray-200'}"></i>`).join('')}
                            </div>
                            <p class="text-xs text-orange-800 font-medium leading-relaxed">${r.aiReview?.feedback || '教練正在觀察您的潛力...'}</p>
                        </div>
                    </td>
                </tr>
            `).join('');
            refreshIcons();
        }

        function showFinalSuccess() {
            document.getElementById('unit-content').innerHTML = `
                <div class="card-pop p-16 text-center animate-fade-in border-t-8 border-green-400">
                    <i data-lucide="award" class="w-20 h-20 text-green-500 mx-auto mb-6"></i>
                    <h2 class="text-4xl font-black mb-4">研習大成功！</h2>
                    <p class="text-gray-500 mb-8">您已經通過所有 AI 挑戰，快去成果牆看看您的教練評價吧！</p>
                    <button onclick="showResults()" class="px-10 py-4 bg-gray-900 text-white rounded-2xl font-bold shadow-xl">進入成果牆</button>
                </div>
            `;
            setTimeout(refreshIcons, 0);
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 3000);
        }

        window.addEventListener('load', refreshIcons);
    </script>
</body>
</html>
