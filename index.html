<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è”¡æ–‡åœ‹å°Gemå¢èƒ½ç ”ç¿’</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Fredoka+One&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; scroll-behavior: smooth; }
        .vibrant-bg { background: linear-gradient(120deg, #fdfbfb 0%, #ebf8ff 100%); }
        .card-pop { 
            background: white;
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.08);
            transition: all 0.3s ease;
        }
        .card-pop:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(59, 130, 246, 0.12); }
        .nav-button {
            padding: 8px 16px;
            border-radius: 12px;
            transition: all 0.2s;
            color: #4b5563;
        }
        .nav-button:hover { background: #eff6ff; color: #2563eb; }
        .nav-button.active { background: #2563eb; color: white; }
        .animate-fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .poster-container {
            position: relative;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 32px;
            overflow: hidden;
            color: white;
            padding: 40px;
            border: 4px solid #3b82f6;
        }
        .circuit-lines {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            opacity: 0.1;
            background-image: radial-gradient(#3b82f6 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
        }
        .xmas-banner {
            background: #dc2626;
            color: white;
            text-align: center;
            padding: 8px;
            font-weight: bold;
            border-radius: 0 0 16px 16px;
            margin: -40px auto 30px;
            width: fit-content;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
        }
        .profile-img {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 4px solid #3b82f6;
            object-fit: cover;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }
        .empathy-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 16px;
            text-align: center;
            transition: all 0.3s;
        }
        .empathy-card:hover { background: rgba(255, 255, 255, 0.15); transform: scale(1.05); }
        .slogan-banner {
            background: linear-gradient(90deg, #3b82f6, #06b6d4);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 30px;
        }
        .content-wrap { white-space: pre-wrap; word-break: break-all; }
        .spinner {
            animation: rotate 2s linear infinite;
            width: 24px;
            height: 24px;
            border: 3px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
        }
        @keyframes rotate { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="vibrant-bg min-h-screen text-gray-800">

    <div id="app" class="max-w-6xl mx-auto px-4 py-8">
        <!-- å°è¦½åˆ— -->
        <nav class="flex flex-col lg:flex-row justify-between items-center mb-8 gap-6 bg-white/80 backdrop-blur-md p-4 rounded-3xl shadow-sm sticky top-4 z-40 border border-blue-50">
            <h1 onclick="showSection('home')" class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-cyan-500 flex items-center gap-2 cursor-pointer">
                <i data-lucide="sparkles" class="text-yellow-400 fill-yellow-400"></i> è”¡æ–‡åœ‹å°Gemå¢èƒ½ç ”ç¿’
            </h1>
            <div id="nav-links" class="flex flex-wrap justify-center gap-2 text-sm font-bold">
                <button onclick="showSection('home')" class="nav-button">é¦–é </button>
                <button onclick="goToUnit(0)" class="nav-button">1.ç­ç´šç¶“ç‡Ÿ</button>
                <button onclick="goToUnit(1)" class="nav-button">2.å­¸ç§‘æ•™å­¸</button>
                <button onclick="goToUnit(2)" class="nav-button">3.è¦ªå¸«æºé€š</button>
                <button onclick="goToUnit(3)" class="nav-button">4.ç­ç´šæ´»å‹•</button>
                <button id="nav-results-btn" onclick="showResults()" class="px-5 py-2 bg-gradient-to-r from-orange-400 to-pink-500 text-white rounded-full hover:scale-105 transition flex items-center gap-2 shadow-md">
                    <i data-lucide="award" class="w-4 h-4"></i> æŸ¥çœ‹æˆæœ
                </button>
            </div>
        </nav>

        <!-- é¦–é  -->
        <section id="home-section" class="section-block space-y-12 animate-fade-in">
            <div class="max-w-3xl mx-auto text-center">
                <h2 class="text-4xl font-black mb-4 text-gray-900 leading-tight">è®“ AI æˆç‚ºæ‚¨çš„éš¨èº«å°è€å¸«ï¼âœ¨</h2>
                <p class="text-xl text-gray-500">æ­¡è¿è”¡æ–‡åœ‹å°çš„å¤¥ä¼´ï¼Œä½¿ç”¨Google Gemsã€‚</p>
            </div>

            <!-- ç ”ç¿’æµ·å ± -->
            <div class="poster-container shadow-2xl">
                <div class="circuit-lines"></div>
                <div class="relative z-10">
                    <header class="xmas-banner">ğŸ„ Merry Christmas! ç¥å¤§å®¶è–èª•å¿«æ¨‚ ğŸ„</header>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                        <div class="space-y-8">
                            <section>
                                <div class="text-blue-400 font-bold tracking-widest mb-2">TSAI WEN ELEMENTARY SCHOOL</div>
                                <h1 class="text-5xl font-black mb-2 flex items-center gap-3"><span class="text-4xl">ğŸ’</span> Google Gems</h1>
                                <h2 class="text-xl font-medium text-blue-200">åœ¨ç­ç´šç¶“ç‡Ÿèˆ‡è¦ªå¸«æºé€šçš„æ‡‰ç”¨</h2>
                            </section>
                            <section class="flex items-center gap-6 bg-white/5 p-6 rounded-3xl border border-white/10">
                                <div class="shrink-0">
                                    <img src="https://class.kh.edu.tw/sites/28380/album_file/1/IMG_20251121_083417.JPG_compressed_.JPEG" alt="è¬›å¸«" class="profile-img">
                                </div>
                                <ul class="space-y-2 text-sm">
                                    <li>ğŸ‘¨â€ğŸ« è¬›å¸«ï¼šHandsome Jack</li>
                                    <li>ğŸ“… æ—¥æœŸï¼š2025/12/26 (äº”)</li>
                                    <li>â° æ™‚é–“ï¼š14ï¼š20 é–‹å§‹</li>
                                    <li>ğŸ“ åœ°é»ï¼šé›»è…¦æ•™å®¤ 1 ğŸ””</li>
                                </ul>
                            </section>
                        </div>
                        <div class="flex flex-col justify-between">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="empathy-card"><h3 class="font-bold text-blue-300">ğŸ›¡ï¸ ç­ç´šç¶“ç‡Ÿ</h3><p class="text-xs text-white/70">å»ºç«‹å¸¸è¦ãƒ»ç§©åºç®¡ç†</p></div>
                                <div class="empathy-card"><h3 class="font-bold text-green-300">ğŸ“š å­¸ç§‘æ•™å­¸</h3><p class="text-xs text-white/70">æ•™æ¡ˆè¼”åŠ©ãƒ»å·®ç•°åŒ–å­¸ç¿’</p></div>
                                <div class="empathy-card"><h3 class="font-bold text-orange-300">ğŸ’¬ è¦ªå¸«æºé€š</h3><p class="text-xs text-white/70">é«˜æ•ˆè¨Šæ¯ãƒ»æº«æš–å›æ‡‰</p></div>
                                <div class="empathy-card"><h3 class="font-bold text-purple-300">âœ¨ æ´»å‹•è¨­è¨ˆ</h3><p class="text-xs text-white/70">å‰µæ„ç™¼æƒ³ãƒ»æµç¨‹è¦åŠƒ</p></div>
                            </div>
                            <section class="slogan-banner">
                                <div class="text-3xl">ğŸ¤–ğŸ•’â¤ï¸</div>
                                <div><h3 class="font-bold text-lg">å–„ç”¨ AI æ™ºæ…§å·¥å…·</h3><p class="text-sm text-blue-100 opacity-90">å°‡å¯¶è²´çš„æ™‚é–“ï¼Œç•™çµ¦çœ¼å‰çš„å­©å­</p></div>
                            </section>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¨±é¡˜æ±  -->
            <div class="card-pop p-8 md:p-12 border-t-8 border-blue-500">
                <div class="bg-gray-50 rounded-3xl p-8 border border-dashed border-gray-300 text-center">
                    <h3 class="text-2xl font-bold mb-6">é–‹å•Ÿç ”ç¿’ï¼</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
                        <div class="space-y-4">
                            <label class="block text-sm font-bold text-gray-700">æˆ‘æ˜¯...</label>
                            <input type="text" id="user-name" class="w-full p-4 rounded-2xl border-2 border-white bg-white shadow-sm outline-none" placeholder="æ‚¨çš„å§“å">
                            <button id="btn-start" onclick="submitWish()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-lg shadow-blue-200">é–‹å•Ÿç ”ç¿’</button>
                        </div>
                        <div class="space-y-4">
                            <label class="block text-sm font-bold text-gray-700">æ‚¨çš„ AI é¡˜æœ›æ˜¯ï¼Ÿ</label>
                            <textarea id="ai-wish" rows="4" class="w-full p-4 rounded-2xl border-2 border-white bg-white shadow-sm outline-none" placeholder="å¸Œæœ› AI èƒ½å¹«æˆ‘..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="units-section" class="section-block hidden space-y-8">
            <div id="unit-content"></div>
        </section>

        <section id="results-section" class="section-block hidden space-y-6">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-6 rounded-3xl shadow-sm">
                <h2 class="text-3xl font-black text-gray-900">ç ”ç¿’æˆæœç‰† ğŸ†</h2>
                <input type="text" id="search-input" oninput="filterResults()" class="p-3 rounded-xl bg-gray-50 border border-gray-200 outline-none text-sm" placeholder="æœå°‹å§“å...">
            </div>
            <div class="card-pop overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 text-gray-500 text-xs font-bold uppercase">
                        <tr><th class="py-4 px-6">è€å¸«</th><th class="py-4 px-6">å–®å…ƒ</th><th class="py-4 px-6">å…§å®¹</th><th class="py-4 px-6">AI æ•™ç·´é»è©•</th></tr>
                    </thead>
                    <tbody id="results-table-body"></tbody>
                </table>
            </div>
        </section>

        <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-8 py-4 rounded-2xl opacity-0 transition-opacity z-50"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // Firebase ç’°å¢ƒè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyCxrOlO-PyQZBknKYpC84XYB7wAxBh6tOA",
            authDomain: "myreadingcheckin.firebaseapp.com",
            projectId: "myreadingcheckin",
            storageBucket: "myreadingcheckin.firebasestorage.app",
            messagingSenderId: "476306591390",
            appId: "1:476306591390:web:697f4c3bbf246c4c81358f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // é‡è¦ï¼šæ­£ç¢ºçš„ appId èˆ‡ é›†åˆè·¯å¾‘ (RULE 1)
        const currentAppId = "cai-wen-teacher-ai-coach-v2";
        const getPublicCollection = (colName) => collection(db, 'artifacts', currentAppId, 'public', 'data', colName);

        let currentUser = null;
        let isAuthReady = false;

        // åˆå§‹åŒ–èº«ä»½é©—è­‰ (RULE 3)
        const initAuth = async () => {
            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    isAuthReady = true;
                    console.log("Auth initialized:", user?.uid);
                });
            } catch (err) {
                console.error("Auth error:", err);
            }
        };
        initAuth();

        const apiKey = ""; // Gemini API å¯†é‘°ç”±ç’°å¢ƒæ³¨å…¥

        // Gemini API èª¿ç”¨é‚è¼¯
        async function fetchWithRetry(url, options, retries = 5, backoff = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return await response.json();
                    if (response.status === 429) {
                        await new Promise(r => setTimeout(r, backoff));
                        backoff *= 2; continue;
                    }
                    throw new Error(`HTTP ${response.status}`);
                } catch (err) {
                    if (i === retries - 1) throw err;
                    await new Promise(r => setTimeout(r, backoff));
                    backoff *= 2;
                }
            }
        }

        async function getAICoachReview(unitTitle, answer) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const systemPrompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„åœ‹å°æ•™è‚² AI é¡§å•ã€‚è«‹è©•ä¼°è€å¸«å°å–®å…ƒå…§å®¹çš„ Role Prompting è¨­å®šï¼Œå›å‚³ JSONï¼š{"score":1-5, "feedback":"å…·é«”å»ºè­°", "badge":"ç¨±è™Ÿ"}`;
            const userQuery = `å–®å…ƒï¼š${unitTitle}\nå…§å®¹ï¼š${answer}`;

            try {
                const result = await fetchWithRetry(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                return JSON.parse(result.candidates[0].content.parts[0].text);
            } catch (e) {
                return { score: 4, feedback: "æ‚¨çš„æƒ³æ³•å¾ˆæ£’ï¼ç›®å‰ AI æ•™ç·´æ­£åœ¨ä¼‘æ¯ï¼Œæ‚¨çš„è³‡æ–™å·²å„²å­˜ã€‚", badge: "èªçœŸæ•™å¸«" };
            }
        }

        // UI èˆ‡ ç ”ç¿’é‚è¼¯
        const units = [
            { id: 1, title: "ç­ç´šç¶“ç‡Ÿï¼šæƒ…ç·’å®‰æ’«å°åŠ©æ‰‹", desc: "è®“ AI æ‰®æ¼”å¿ƒç†è«®å•†å¸«è§’è‰²ã€‚", quiz: "å¦‚æœè¦æŠŠ AI è¨­å®šç‚ºè”¡æ–‡åœ‹å°çš„ã€ç­ç´šå¿ƒç†æ•™ç·´ã€ï¼Œæ‚¨æœƒå¦‚ä½•è¨­å®šå®ƒçš„è§’è‰²ï¼Ÿ" },
            { id: 2, title: "å­¸ç§‘æ•™å­¸ï¼šå‰µæ„æ•™æ¡ˆè¨­è¨ˆå¸«", desc: "æ˜ç¢ºå‘ŠçŸ¥ AI éœ€è¦åŸ·è¡Œçš„ä»»å‹™ã€‚", quiz: "å¦‚æœè¦ AI å¹«æ‚¨å‡ºä¸€ä»½äº”å¹´ç´šæ•¸å­¸ã€åˆ†æ•¸ä¹˜æ³•ã€çš„æƒ…å¢ƒé¡Œï¼Œæ‚¨æœƒçµ¦å®ƒç”šéº¼ä»»å‹™ï¼Ÿ" },
            { id: 3, title: "è¦ªå¸«æºé€šï¼šå§”å©‰æ–‡å­—ç¿»è­¯å®˜", desc: "æä¾›å¿…è¦çš„ä¸Šä¸‹æ–‡æˆ–é¢¨æ ¼è¦æ±‚ã€‚", quiz: "ç­ç´šç‹€æ³è¤‡é›œå¤šæ¨£ï¼Œæ‚¨æœƒå¦‚ä½•è¨­å®š AI çš„èƒŒæ™¯è³‡è¨Šï¼Ÿ" },
            { id: 4, title: "ç­ç´šæ´»å‹•ï¼šæ´»å‹•ä¼åŠƒå¤§å¸«", desc: "æŒ‡å®šéœ€è¦çš„è¼¸å‡ºæ ¼å¼ã€‚", quiz: "æ ¡åœ’æ´»å‹•è±å¯Œæœ‰è¶£ï¼Œæ‚¨æœƒå¸Œæœ› AI çµ¦ä½ ç”šéº¼å»ºè­°ï¼Ÿ" }
        ];

        let currentUnitIndex = 0;
        let globalUserName = "";
        let allResults = [];

        window.showSection = (id) => {
            document.querySelectorAll('.section-block').forEach(s => s.classList.add('hidden'));
            document.getElementById(`${id}-section`).classList.remove('hidden');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.goToUnit = (index) => {
            if (!globalUserName) return;
            currentUnitIndex = index;
            renderUnit();
            showSection('units');
        };

        window.submitWish = async () => {
            if (!isAuthReady || !currentUser) { showToast("ç³»çµ±é€£ç·šä¸­ï¼Œè«‹ç¨å€™..."); return; }
            const name = document.getElementById('user-name').value;
            if (!name) { alert("è«‹è¼¸å…¥å§“å"); return; }
            globalUserName = name;
            goToUnit(0);
        };

        window.renderUnit = () => {
            const unit = units[currentUnitIndex];
            document.getElementById('unit-content').innerHTML = `
                <div class="card-pop p-8 border-t-8 border-blue-500 animate-fade-in">
                    <h3 class="text-2xl font-black mb-4">${unit.title}</h3>
                    <p class="text-gray-600 mb-8">${unit.desc}</p>
                    <div class="bg-yellow-50 p-6 rounded-2xl border-2 border-yellow-100">
                        <h4 class="font-bold mb-4">${unit.quiz}</h4>
                        <textarea id="quiz-answer" rows="5" class="w-full p-4 rounded-xl mb-4 border-0 shadow-inner" placeholder="è«‹è¼¸å…¥ Prompt..."></textarea>
                        <div id="loading-ai" class="hidden text-blue-600 font-bold mb-4 flex items-center gap-2"><div class="spinner"></div> AI è©•åˆ†ä¸­...</div>
                        <button id="submit-btn" onclick="submitQuiz()" class="w-full py-4 bg-gray-900 text-white rounded-xl font-bold">æäº¤è©•åˆ†</button>
                    </div>
                </div>
            `;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.submitQuiz = async () => {
            if (!currentUser) { showToast("é©—è­‰å¤±æ•ˆï¼Œè«‹é‡æ–°æ•´ç†é é¢"); return; }
            const answer = document.getElementById('quiz-answer').value;
            if (!answer) return;
            
            const btn = document.getElementById('submit-btn');
            const loader = document.getElementById('loading-ai');
            btn.disabled = true; loader.classList.remove('hidden');

            try {
                const aiReview = await getAICoachReview(units[currentUnitIndex].title, answer);
                
                // åŸ·è¡Œå­˜æª” (ä½¿ç”¨è¦ç¯„è·¯å¾‘)
                await addDoc(getPublicCollection('quizResults'), {
                    unitName: units[currentUnitIndex].title,
                    name: globalUserName,
                    answer: answer,
                    aiReview: aiReview,
                    timestamp: serverTimestamp(),
                    userId: currentUser.uid
                });

                showToast("å·²æäº¤ï¼");
                if (currentUnitIndex < units.length - 1) {
                    currentUnitIndex++; renderUnit();
                } else {
                    showFinalSuccess();
                }
            } catch (err) {
                console.error("Save error:", err);
                showToast("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™è¨­å®š");
                btn.disabled = false; loader.classList.add('hidden');
            }
        };

        window.showResults = async () => {
            if (!currentUser) return;
            showSection('results');
            const tbody = document.getElementById('results-table-body');
            tbody.innerHTML = '<tr><td colspan="4" class="py-10 text-center">è¼‰å…¥ä¸­...</td></tr>';
            
            try {
                // RULE 2: ä¸ä½¿ç”¨è¤‡é›œæŸ¥è©¢ï¼ŒæŠ“å–å¾Œè‡ªè¡Œæ’åº
                const snap = await getDocs(getPublicCollection('quizResults'));
                allResults = snap.docs.map(d => d.data());
                renderTable(allResults);
            } catch (err) {
                console.error("Fetch error:", err);
                tbody.innerHTML = '<tr><td colspan="4" class="py-10 text-center text-red-500">ç„¡æ³•è®€å–è³‡æ–™ï¼Œè«‹ç¢ºèªè·¯å¾‘æ¬Šé™ã€‚</td></tr>';
            }
        };

        function renderTable(data) {
            document.getElementById('results-table-body').innerHTML = data.map(r => `
                <tr class="border-b">
                    <td class="py-4 px-6 font-bold">${r.name}</td>
                    <td class="py-4 px-6 text-sm text-blue-600">${r.unitName}</td>
                    <td class="py-4 px-6 text-sm">${r.answer}</td>
                    <td class="py-4 px-6 text-xs bg-orange-50">${r.aiReview?.feedback || 'è®šï¼'}</td>
                </tr>
            `).join('');
        }

        function showFinalSuccess() {
            document.getElementById('unit-content').innerHTML = `
                <div class="card-pop p-16 text-center">
                    <h2 class="text-3xl font-black mb-6">ç ”ç¿’æŒ‘æˆ°é”æˆï¼âœ¨</h2>
                    <button onclick="showResults()" class="px-8 py-3 bg-blue-600 text-white rounded-xl font-bold">æŸ¥çœ‹ç ”ç¿’æˆæœç‰†</button>
                </div>
            `;
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 3000);
        }
    </script>
</body>
</html>
