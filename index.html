<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è”¡æ–‡åœ‹å°Gemå¢èƒ½ç ”ç¿’ - AI æ•™ç·´ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Fredoka+One&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; scroll-behavior: smooth; }
        .vibrant-bg { background: linear-gradient(120deg, #fdfbfb 0%, #ebf8ff 100%); }
        .card-pop { 
            background: white;
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.08);
            transition: all 0.3s ease;
        }
        .card-pop:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(59, 130, 246, 0.12); }
        .nav-button {
            padding: 8px 16px;
            border-radius: 12px;
            transition: all 0.2s;
            color: #4b5563;
        }
        .nav-button:hover { background: #eff6ff; color: #2563eb; }
        .nav-button.active { background: #2563eb; color: white; }
        .animate-fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        /* ç ”ç¿’æµ·å ±æ¨£å¼ */
        .poster-container {
            position: relative;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 32px;
            overflow: hidden;
            color: white;
            padding: 40px;
            border: 4px solid #3b82f6;
        }
        .circuit-lines {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            opacity: 0.1;
            background-image: radial-gradient(#3b82f6 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
        }
        .xmas-banner {
            background: #dc2626;
            color: white;
            text-align: center;
            padding: 8px;
            font-weight: bold;
            border-radius: 16px 16px 16px 16px;
            margin: -40px auto 30px;
            width: 100%;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
        }
        .profile-img {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 4px solid #3b82f6;
            object-fit: cover;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }
        .empathy-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 16px;
            text-align: center;
            transition: all 0.3s;
        }
        .empathy-card:hover { background: rgba(255, 255, 255, 0.15); transform: scale(1.05); }
        .slogan-banner {
            background: linear-gradient(90deg, #3b82f6, #06b6d4);
            border-radius: 20px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 30px;
        }

        .content-wrap { white-space: pre-wrap; word-break: break-all; }
        
        .spinner {
            animation: rotate 2s linear infinite;
            width: 24px;
            height: 24px;
            border: 3px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
        }
        @keyframes rotate { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="vibrant-bg min-h-screen text-gray-800">

    <div id="app" class="max-w-6xl mx-auto px-4 py-8">
        <!-- å°è¦½åˆ— -->
        <nav class="flex flex-col lg:flex-row justify-between items-center mb-8 gap-6 bg-white/80 backdrop-blur-md p-4 rounded-3xl shadow-sm sticky top-4 z-40 border border-blue-50">
            <h1 onclick="showSection('home')" class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-cyan-500 flex items-center gap-2 cursor-pointer">
                <i data-lucide="sparkles" class="text-yellow-400 fill-yellow-400"></i> è”¡æ–‡åœ‹å°Gemå¢èƒ½ç ”ç¿’
            </h1>
            <div id="nav-links" class="flex flex-wrap justify-center gap-2 text-sm font-bold">
                <button onclick="showSection('home')" class="nav-button">é¦–é </button>
                <button onclick="goToUnit(0)" class="nav-button">1.ç­ç´šç¶“ç‡Ÿ</button>
                <button onclick="goToUnit(1)" class="nav-button">2.å­¸ç§‘æ•™å­¸</button>
                <button onclick="goToUnit(2)" class="nav-button">3.è¦ªå¸«æºé€š</button>
                <button onclick="goToUnit(3)" class="nav-button">4.ç­ç´šæ´»å‹•</button>
                <button id="nav-results-btn" onclick="showResults()" class="px-5 py-2 bg-gradient-to-r from-orange-400 to-pink-500 text-white rounded-full hover:scale-105 transition flex items-center gap-2 shadow-md">
                    <i data-lucide="award" class="w-4 h-4"></i> æŸ¥çœ‹ç ”ç¿’æˆæœç‰†
                </button>
            </div>
        </nav>

        <!-- é¦–é  -->
        <section id="home-section" class="section-block space-y-12 animate-fade-in">
            <!-- æ¨™é¡Œèˆ‡ç°¡ä»‹ -->
            <div class="max-w-3xl mx-auto text-center">
                <h2 class="text-4xl font-black mb-4 text-gray-900 leading-tight">è®“ AI æˆç‚ºæ‚¨çš„éš¨èº«å°åŠ©ç†ï¼âœ¨</h2>
                <p class="text-xl text-gray-500">æ­¡è¿è”¡æ–‡åœ‹å°çš„å¤¥ä¼´ï¼Œä½¿ç”¨Google GemsåŠŸèƒ½ã€‚</p>
            </div>

            <!-- ç ”ç¿’æµ·å ±å€å¡Š -->
            <div class="poster-container shadow-2xl">
                <div class="circuit-lines"></div>
                <div class="relative z-10">
                    <header class="xmas-banner">
                        ğŸ„ Merry Christmas! ç¥å¤§å®¶è–èª•å¿«æ¨‚ ğŸ„
                    </header>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                        <!-- æµ·å ±å·¦å´ -->
                        <div class="space-y-8">
                            <section>
                                <div class="text-blue-400 font-bold tracking-widest mb-2">TSAI WEN ELEMENTARY SCHOOL</div>
                                <h1 class="text-5xl font-black mb-2 flex items-center gap-3">
                                    <span class="text-4xl">ğŸ’</span> Google Gems
                                </h1>
                                <h2 class="text-xl font-medium text-blue-200">åœ¨ç­ç´šç¶“ç‡Ÿèˆ‡è¦ªå¸«æºé€šçš„æ‡‰ç”¨</h2>
                            </section>

                            <section class="flex items-center gap-6 bg-white/5 p-6 rounded-3xl border border-white/10">
                                <div class="shrink-0">
                                    <img src="https://class.kh.edu.tw/sites/28380/album_file/1/IMG_20251121_083417.JPG_compressed_.JPEG" alt="Handsome Jack" class="profile-img">
                                </div>
                                <ul class="space-y-2 text-sm">
                                    <li class="flex items-center gap-2"><span class="w-6 text-center">ğŸ‘¨â€ğŸ«</span> è¬›å¸«ï¼šHandsome Jack</li>
                                    <li class="flex items-center gap-2"><span class="w-6 text-center">ğŸ“…</span> æ—¥æœŸï¼š2025/12/26 (äº”)</li>
                                    <li class="flex items-center gap-2"><span class="w-6 text-center">â°</span> æ™‚é–“ï¼š14ï¼š20 é–‹å§‹</li>
                                    <li class="flex items-center gap-2"><span class="w-6 text-center">ğŸ“</span> åœ°é»ï¼šé›»è…¦æ•™å®¤ 1 ğŸ””</li>
                                </ul>
                            </section>
                        </div>

                        <!-- æµ·å ±å³å´ -->
                        <div class="flex flex-col justify-between">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="empathy-card">
                                    <h3 class="font-bold text-blue-300 mb-1">ğŸ›¡ï¸ ç­ç´šç¶“ç‡Ÿ</h3>
                                    <p class="text-xs text-white/70">å»ºç«‹å¸¸è¦ãƒ»ç§©åºç®¡ç†</p>
                                </div>
                                <div class="empathy-card">
                                    <h3 class="font-bold text-green-300 mb-1">ğŸ“š å­¸ç§‘æ•™å­¸</h3>
                                    <p class="text-xs text-white/70">æ•™æ¡ˆè¼”åŠ©ãƒ»å·®ç•°åŒ–å­¸ç¿’</p>
                                </div>
                                <div class="empathy-card">
                                    <h3 class="font-bold text-orange-300 mb-1">ğŸ’¬ è¦ªå¸«æºé€š</h3>
                                    <p class="text-xs text-white/70">é«˜æ•ˆè¨Šæ¯ãƒ»æº«æš–å›æ‡‰</p>
                                </div>
                                <div class="empathy-card">
                                    <h3 class="font-bold text-purple-300 mb-1">âœ¨ æ´»å‹•è¨­è¨ˆ</h3>
                                    <p class="text-xs text-white/70">å‰µæ„ç™¼æƒ³ãƒ»æµç¨‹è¦åŠƒ</p>
                                </div>
                            </div>

                            <section class="slogan-banner">
                                <div class="text-3xl">ğŸ¤–ğŸ•’â¤ï¸</div>
                                <div>
                                    <h3 class="font-bold text-lg">å–„ç”¨ AI æ™ºæ…§å·¥å…·</h3>
                                    <p class="text-sm text-blue-100 opacity-90">å°‡å¯¶è²´çš„æ™‚é–“ï¼Œç•™çµ¦çœ¼å‰çš„å­©å­</p>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ•™å¸«æ—¥å¸¸å…±æ„Ÿå€ -->
            <section class="card-pop p-8 md:p-10 border-l-8 border-amber-400 animate-fade-in">
                <h3 class="text-2xl font-black mb-6 text-gray-800 flex items-center gap-2">
                    <span>ğŸ§‘â€ğŸ«</span> è€å¸«çš„ä¸€å¤©ï¼Œå¾ä¾†ä¸åªä¸Šèª²
                </h3>

                <p class="text-gray-600 mb-6 leading-relaxed">
                    åœ¨æ­£å¼é«”é©— Gem ä¹‹å‰ï¼Œæˆ‘å€‘å…ˆä¸€èµ·çœ‹çœ‹â€”â€”  
                    <span class="font-bold text-gray-800">è€å¸«æ¯å¤©é»˜é»˜åœ¨åšã€å»å¾ˆå°‘è¢«çœ‹è¦‹çš„é‚£äº›äº‹ã€‚</span>
                </p>

                <ul class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700 text-sm">
                    <li class="bg-gray-50 p-4 rounded-xl flex items-center gap-2">ğŸ“’ æ”¹ä½œæ¥­ã€çœ‹è¯çµ¡ç°¿ã€å›å®¶é•·è¨Šæ¯</li>
                    <li class="bg-gray-50 p-4 rounded-xl flex items-center gap-2">ğŸ“Š å¡«å¯«å„å¼è¡¨å–®ã€å›å ±ã€ç³»çµ±è³‡æ–™</li>
                    <li class="bg-gray-50 p-4 rounded-xl flex items-center gap-2">ğŸ§  æƒ³æ•™å­¸èª¿æ•´ã€å·®ç•°åŒ–ã€è£œæ•‘ç­–ç•¥</li>
                    <li class="bg-gray-50 p-4 rounded-xl flex items-center gap-2">ğŸ’¬ è™•ç†å­¸ç”Ÿè¡çªã€æƒ…ç·’å®‰æ’«</li>
                    <li class="bg-gray-50 p-4 rounded-xl flex items-center gap-2">ğŸ‰ è¦åŠƒæ´»å‹•ã€æ ¡å¤–æ•™å­¸ã€ç¯€æ…¶æµç¨‹</li>
                    <li class="bg-gray-50 p-4 rounded-xl flex items-center gap-2">â° ä¸‹ç­å¾Œï¼Œè…¦è¢‹é‚„åœ¨æƒ³æ˜å¤©çš„å­©å­</li>
                </ul>

                <div class="mt-8 bg-amber-50 border border-amber-200 rounded-2xl p-6 text-center">
                    <p class="font-bold text-amber-700 text-lg">å¦‚æœæœ‰ä¸€å€‹ AIï¼Œèƒ½å¹«ä½ åˆ†æ“”é€™äº›ã€ŒèŠ±æ™‚é–“å»å¾ˆé‡è¦çš„äº‹ã€...</p>
                    <p class="text-gray-700 mt-2">ä½ æœƒæƒ³æŠŠæ™‚é–“ï¼Œç•™çµ¦èª°ï¼Ÿ</p>
                </div>
            </section>

            <!-- è¨±é¡˜æ± å€å¡Š -->
            <div class="card-pop p-8 md:p-12 border-t-8 border-blue-500">
                <div class="bg-gray-50 rounded-3xl p-8 border border-dashed border-gray-300">
                    <h3 class="text-2xl font-bold mb-6 text-center">æº–å‚™å¥½äº†å—ï¼Ÿå…ˆè¨±å€‹é¡˜é–‹å•Ÿç ”ç¿’ï¼</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">æˆ‘æ˜¯...</label>
                                <input type="text" id="user-name" class="w-full p-4 rounded-2xl border-2 border-white bg-white shadow-sm focus:border-blue-400 outline-none transition" placeholder="æ‚¨çš„å§“å">
                            </div>
                            <button onclick="submitWish()" id="btn-submit-wish" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl hover:bg-blue-700 transition-all hover:shadow-xl hover:scale-[1.02] active:scale-95 shadow-lg shadow-blue-200 text-lg">
                                é–‹å•Ÿ Gem ç ”ç¿’å–®å…ƒ
                            </button>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">æ‚¨çš„ AI é¡˜æœ›æ˜¯ï¼Ÿ</label>
                            <textarea id="ai-wish" rows="4" class="w-full p-4 rounded-2xl border-2 border-white bg-white shadow-sm focus:border-blue-400 outline-none transition" placeholder="ä¾‹å¦‚ï¼šå¸Œæœ› AI èƒ½å¹«æˆ‘å¯«å‡ºæœ‰æº«åº¦çš„è¦ªå¸«è¯çµ¡æ–‡å­—..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- å­¸ç¿’å–®å…ƒå€åŸŸ (ä¿®æ­£é—œéµï¼šè£œä¸Š unit-content) -->
        <section id="units-section" class="section-block hidden space-y-8">
            <div id="unit-content"></div>
        </section>

        <!-- ç ”ç¿’æˆæœç‰†å€åŸŸ -->
        <section id="results-section" class="section-block hidden space-y-6 animate-fade-in">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-6 rounded-3xl shadow-sm border border-blue-50">
                <h2 class="text-3xl font-black text-gray-900">ç ”ç¿’æˆæœç‰† ğŸ†</h2>
                <div class="relative w-full md:w-64">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"></i>
                    <input type="text" id="search-input" oninput="filterResults()" class="w-full pl-10 pr-4 py-2 rounded-xl bg-gray-50 border-2 border-transparent focus:border-blue-400 outline-none transition text-sm" placeholder="æœå°‹è€å¸«å§“åæˆ–å…§å®¹...">
                </div>
            </div>
            
            <div class="card-pop overflow-hidden border border-gray-100">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-bold">
                            <tr>
                                <th class="py-4 px-6">è€å¸«</th>
                                <th class="py-4 px-6">å–®å…ƒ</th>
                                <th class="py-4 px-6">å­¸ç¿’å¿ƒå¾— / è¨­å®šå…§å®¹</th>
                                <th class="py-4 px-6">AI æ•™ç·´é»è©•</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body" class="text-gray-700">
                            <!-- ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-gray-900/90 backdrop-blur text-white px-8 py-4 rounded-2xl opacity-0 transition-opacity pointer-events-none z-50 shadow-2xl font-bold">è³‡æ–™å·²å„²å­˜ï¼</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCxrOlO-PyQZBknKYpC84XYB7wAxBh6tOA",
            authDomain: "myreadingcheckin.firebaseapp.com",
            projectId: "myreadingcheckin",
            storageBucket: "myreadingcheckin.firebasestorage.app",
            messagingSenderId: "476306591390",
            appId: "1:476306591390:web:697f4c3bbf246c4c81358f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = "cai-wen-teacher-ai-coach-v2";
        const resultsCollectionPath = ['artifacts', appId, 'public', 'data', 'quizResults'];
        const apiKey = ""; 

        signInAnonymously(auth);

        const units = [
            { id: 1, title: "ç­ç´šç¶“ç‡Ÿï¼šæƒ…ç·’å®‰æ’«å°åŠ©æ‰‹", desc: "è¨­è¨ˆå°ˆæ¥­çš„å¿ƒç†è¼”å°è§’è‰²ã€‚", gemExample: "ä½ ç¾åœ¨æ˜¯ä¸€ä½æº«å’Œçš„å…’ç«¥å¿ƒç†è€å¸«...", quiz: "å¦‚æœ AI æ˜¯ä¸€ä½è³‡æ·±ç­å°å¸«ï¼Œå®ƒæ‡‰è©²å…·å‚™ä»€éº¼æ¨£çš„è§’è‰²æ€§æ ¼èˆ‡èªªè©±èªæ°£ï¼Ÿ" },
            { id: 2, title: "å­¸ç§‘æ•™å­¸ï¼šå‰µæ„æ•™æ¡ˆè¨­è¨ˆå¸«", desc: "æŠŠç”Ÿæ¾€èª²ç¨‹è®Šèº«å†’éšªéŠæˆ²ã€‚", gemExample: "ä½ æ˜¯ä¸€ä½å……æ»¿å¥½å¥‡å¿ƒçš„å†’éšªå®¶ï¼Œè«‹è¨­è¨ˆæ•¸å­¸éŠæˆ²...", quiz: "å¦‚æœè¦è®“ AI è¨­è¨ˆã€åœ‹èªä¿®è¾­ã€æ•™æ¡ˆï¼Œæ‚¨æœƒå¦‚ä½•è¨­å®šå®ƒçš„å°ˆå®¶è§’è‰²èƒŒæ™¯ï¼Ÿ" },
            { id: 3, title: "è¦ªå¸«æºé€šï¼šå§”å©‰æ–‡å­—ç¿»è­¯å®˜", desc: "å°‡æƒ³èªªçš„è©±ï¼Œä¿®é£¾å¾—æ›´æœ‰æº«åº¦ã€‚", gemExample: "ä½ æ˜¯ä¸€ä½è³‡æ·±è¦ªå¸«æºé€šå°ˆå®¶...", quiz: "ç•¶å­©å­ç™¼ç”Ÿåå·®è¡Œç‚ºéœ€å‘ŠçŸ¥å®¶é•·ï¼Œæ‚¨æœƒè¦æ±‚ AI ä»¥ä»€éº¼æ¨£çš„å£å»æ‰®æ¼”ã€Œæ ¡åœ’å°å¸«ã€ï¼Ÿ" },
            { id: 4, title: "ç­ç´šæ´»å‹•ï¼šæ´»å‹•ä¼åŠƒå¤§å¸«", desc: "è®“ç¯€æ…¶æ´»å‹•ä¸å†åƒç¯‡ä¸€å¾‹ã€‚", gemExample: "ä½ æ˜¯ä¸€ä½å¾—ççš„å…’ç«¥æ´»å‹•ç­–å±•äºº...", quiz: "è¦åŠƒè”¡æ–‡åœ‹å°æ ¡æ…¶é—–é—œæ™‚ï¼Œæ‚¨æœƒå¸Œæœ› AI æ‰®æ¼”ä»€éº¼æ¨£çš„è§’è‰²ä¾†æä¾›å‰µæ„ï¼Ÿ" }
        ];

        let currentUnitIndex = 0;
        let globalUserName = "";
        let allResults = [];

        const refreshIcons = () => { if (typeof lucide !== 'undefined') lucide.createIcons(); };

        async function getAICoachReview(unitTitle, answer) {
            const systemPrompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ Prompt Engineering è¬›å¸«ï¼Œè©•ä¼°åœ‹å°è€å¸«å° Gemini çš„è§’è‰²è¨­å®šã€‚è«‹å›å‚³ JSON: {"score":1-5, "feedback":"ä¸­æ–‡å»ºè­°", "badge":"ç¨±è™Ÿ"}`;
            const userQuery = `å­¸ç¿’å–®å…ƒï¼š${unitTitle}\nå…§å®¹ï¼š${answer}`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const data = await response.json();
                return JSON.parse(data.candidates[0].content.parts[0].text);
            } catch (e) {
                return { score: 3, feedback: "AI æ•™ç·´ç›®å‰ç¹å¿™ï¼Œä½†æ‚¨çš„åŠªåŠ›å·²è¢«è¨˜éŒ„ï¼", badge: "å‹¤å¥®å¤¥ä¼´" };
            }
        }

        window.showSection = (id) => {
            const sections = document.querySelectorAll('.section-block');
            sections.forEach(sec => sec.classList.add('hidden'));
            document.getElementById(`${id}-section`).classList.remove('hidden');
            refreshIcons();
        };

        window.goToUnit = (index) => {
            if (!globalUserName) { showToast("è«‹å…ˆè¼¸å…¥å§“åï¼"); return; }
            currentUnitIndex = index;
            renderUnit();
            showSection('units');
        };

        window.submitWish = async () => {
            const name = document.getElementById('user-name').value;
            const wish = document.getElementById('ai-wish').value;
            if (!name) { showToast("è«‹è¼¸å…¥å§“åï¼"); return; }
            globalUserName = name;
            await addDoc(collection(db, ...resultsCollectionPath), { 
                unitName: "ç ”ç¿’åˆè¡·", name, answer: wish || "åŠ æ²¹ï¼", timestamp: serverTimestamp(), aiReview: { score: 5, feedback: "éå¸¸æ£’çš„é–‹å§‹ï¼é¡˜æœ›æ¸…å–®å·²åŒæ­¥ã€‚", badge: "å¤¢æƒ³å®¶" } 
            });
            goToUnit(0);
        };

        window.renderUnit = () => {
            const unit = units[currentUnitIndex];
            const container = document.getElementById('unit-content');
            if (!container) return; // å®‰å…¨æª¢æŸ¥

            container.innerHTML = `
                <div class="card-pop p-8 md:p-12 border-t-8 border-blue-500 animate-fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-black">${unit.title}</h3>
                        <span class="text-sm font-bold bg-blue-50 text-blue-600 px-4 py-1 rounded-full">UNIT ${unit.id}/4</span>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <p class="text-gray-600 mb-4">${unit.desc}</p>
                            <div class="bg-blue-50 p-6 rounded-2xl mb-6">
                                <h5 class="text-xs font-black text-blue-700 mb-2 uppercase">è¨­å®šç¯„ä¾‹</h5>
                                <p class="text-sm italic">ã€Œ${unit.gemExample}ã€</p>
                            </div>
                        </div>
                        <div class="bg-yellow-50 p-8 rounded-3xl border-2 border-yellow-200">
                            <h4 class="font-bold mb-3">${unit.quiz}</h4>
                            <textarea id="quiz-answer" rows="5" class="w-full p-4 rounded-2xl mb-4 border-2 border-transparent focus:border-orange-400 outline-none" placeholder="è¼¸å…¥æ‚¨çš„è¨­å®š..."></textarea>
                            <div id="loading-ai" class="hidden items-center gap-3 mb-4 text-blue-600 font-bold">
                                <div class="spinner"></div> AI æ•™ç·´è©•é‘‘ä¸­...
                            </div>
                            <button id="submit-btn" onclick="submitQuiz()" class="w-full py-4 bg-gray-900 text-white rounded-2xl font-bold hover:bg-black transition">æäº¤ä¸¦ç”± AI è©•é–±</button>
                        </div>
                    </div>
                </div>
            `;
            refreshIcons();
        };

        window.submitQuiz = async () => {
            const answer = document.getElementById('quiz-answer').value;
            if (!answer) return;
            const btn = document.getElementById('submit-btn');
            const loader = document.getElementById('loading-ai');
            btn.disabled = true; loader.classList.remove('hidden');
            try {
                const aiReview = await getAICoachReview(units[currentUnitIndex].title, answer);
                await addDoc(collection(db, ...resultsCollectionPath), {
                    unitName: units[currentUnitIndex].title, name: globalUserName, answer, aiReview, timestamp: serverTimestamp()
                });
                showToast("AI å·²å®Œæˆè©•é–±ï¼");
                if (currentUnitIndex < units.length - 1) { currentUnitIndex++; renderUnit(); }
                else { showFinalSuccess(); }
            } catch (e) { 
                showToast("æäº¤ç™¼ç”ŸéŒ¯èª¤"); 
                btn.disabled = false;
                loader.classList.add('hidden');
            }
        };

        window.showResults = async () => {
            showSection('results');
            const tbody = document.getElementById('results-table-body');
            tbody.innerHTML = '<tr><td colspan="4" class="py-20 text-center text-gray-400"><div class="spinner mx-auto mb-2"></div>è¼‰å…¥ä¸­...</td></tr>';
            try {
                const snap = await getDocs(collection(db, ...resultsCollectionPath));
                allResults = snap.docs.map(d => d.data()).sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                renderTable(allResults);
            } catch (e) { tbody.innerHTML = '<tr><td colspan="4" class="py-20 text-center">ç›®å‰å°šç„¡è³‡æ–™</td></tr>'; }
        };

        function renderTable(data) {
            document.getElementById('results-table-body').innerHTML = data.map(r => `
                <tr class="border-b hover:bg-white transition group">
                    <td class="py-6 px-6 align-top font-bold">${r.name}<div class="text-[10px] text-gray-400 uppercase">${r.aiReview?.badge || 'ç ”ç¿’ç”Ÿ'}</div></td>
                    <td class="py-6 px-6 align-top"><span class="text-xs font-bold text-blue-500">${r.unitName}</span></td>
                    <td class="py-6 px-6 align-top"><div class="content-wrap text-sm text-gray-600 bg-gray-50 p-4 rounded-xl">${r.answer}</div></td>
                    <td class="py-6 px-6 align-top">
                        <div class="bg-white border border-orange-100 p-4 rounded-xl shadow-sm">
                            <div class="flex gap-1 mb-2">
                                ${Array(5).fill(0).map((_, i) => `<i data-lucide="star" class="w-3 h-3 ${i < (r.aiReview?.score || 0) ? 'fill-orange-400 text-orange-400' : 'text-gray-200'}"></i>`).join('')}
                            </div>
                            <p class="text-xs text-orange-800 font-medium">${r.aiReview?.feedback || 'è©•é–±ä¸­...'}</p>
                        </div>
                    </td>
                </tr>
            `).join('');
            refreshIcons();
        }

        window.filterResults = () => {
            const kw = document.getElementById('search-input').value.toLowerCase();
            const filtered = allResults.filter(r => r.name.toLowerCase().includes(kw) || r.answer.toLowerCase().includes(kw));
            renderTable(filtered);
        };

        function showFinalSuccess() {
            const container = document.getElementById('unit-content');
            if (!container) return;
            container.innerHTML = `
                <div class="card-pop p-16 text-center animate-fade-in border-t-8 border-green-400">
                    <i data-lucide="award" class="w-20 h-20 text-green-500 mx-auto mb-6"></i>
                    <h2 class="text-4xl font-black mb-4">ç ”ç¿’å¤§æˆåŠŸï¼</h2>
                    <button onclick="showResults()" class="px-10 py-4 bg-gray-900 text-white rounded-2xl font-bold shadow-xl">é€²å…¥æˆæœç‰†</button>
                </div>
            `;
            setTimeout(refreshIcons, 0);
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 3000);
        }

        window.addEventListener('load', refreshIcons);
    </script>
</body>
</html>
